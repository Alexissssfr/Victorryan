<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Victorryan</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .container {
        margin-top: 20px;
      }
      .hidden {
        display: none;
      }
      button {
        padding: 8px 16px;
        background-color: #4caf50;
        color: white;
        border: none;
        cursor: pointer;
      }
      input {
        padding: 8px;
        margin-bottom: 10px;
        width: 100%;
      }
      .game-id {
        background-color: #f1f1f1;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <h1>Victorryan - Jeu de cartes</h1>

    <!-- Écran initial -->
    <div id="homeScreen">
      <button id="createGameBtn">Créer une partie</button>
      <hr />
      <div>
        <h3>Rejoindre une partie</h3>
        <input type="text" id="playerNameInput" placeholder="Votre nom" />
        <input type="text" id="gameIdInput" placeholder="ID de la partie" />
        <button id="joinGameBtn">Rejoindre</button>
      </div>
    </div>

    <!-- Écran de création de partie -->
    <div id="createdGameScreen" class="hidden">
      <h2>Partie créée!</h2>
      <p>Partagez cet ID avec votre adversaire:</p>
      <div class="game-id">
        <span id="gameIdDisplay"></span>
        <button id="copyGameIdBtn">Copier</button>
      </div>
      <div>
        <input type="text" id="creatorNameInput" placeholder="Votre nom" />
        <button id="joinAsCreatorBtn">Rejoindre en tant que créateur</button>
      </div>
    </div>

    <!-- Écran d'attente -->
    <div id="waitingScreen" class="hidden">
      <h2>En attente...</h2>
      <p id="waitingMessage">En attente d'un adversaire</p>
    </div>

    <!-- Écran de jeu -->
    <div id="gameScreen" class="hidden">
      <h2>Partie en cours</h2>
      <div id="gameStatus"></div>
      <div class="container">
        <div id="yourCards">
          <h3>Vos cartes</h3>
          <div id="cardContainer"></div>
        </div>
        <div id="opponentCards">
          <h3>Cartes adverses</h3>
          <div id="opponentCardContainer"></div>
        </div>
      </div>
      <button id="endTurnBtn" class="hidden">Terminer le tour</button>
    </div>

    <div id="messages"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // DOM Elements
        const screens = {
          home: document.getElementById("homeScreen"),
          created: document.getElementById("createdGameScreen"),
          waiting: document.getElementById("waitingScreen"),
          game: document.getElementById("gameScreen"),
        };

        const createGameBtn = document.getElementById("createGameBtn");
        const joinGameBtn = document.getElementById("joinGameBtn");
        const joinAsCreatorBtn = document.getElementById("joinAsCreatorBtn");
        const gameIdDisplay = document.getElementById("gameIdDisplay");
        const copyGameIdBtn = document.getElementById("copyGameIdBtn");
        const gameStatus = document.getElementById("gameStatus");
        const endTurnBtn = document.getElementById("endTurnBtn");
        const messages = document.getElementById("messages");

        // Game State
        let currentGame = {
          gameId: null,
          playerId: null,
          playerName: null,
          isMyTurn: false,
        };

        // Socket.io
        const socket = io();

        // Functions
        function showScreen(screenName) {
          Object.keys(screens).forEach((key) => {
            screens[key].classList.add("hidden");
          });
          screens[screenName].classList.remove("hidden");
        }

        function showMessage(text, isError = false) {
          const p = document.createElement("p");
          p.textContent = text;
          if (isError) p.style.color = "red";
          messages.appendChild(p);
          messages.scrollTop = messages.scrollHeight;
        }

        // Event handlers
        createGameBtn.addEventListener("click", () => {
          fetch("/api/games", {
            method: "POST",
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                currentGame.gameId = data.gameId;
                gameIdDisplay.textContent = data.gameId;
                showScreen("created");
              } else {
                showMessage("Erreur: " + data.error, true);
              }
            })
            .catch((error) => {
              showMessage("Erreur de connexion", true);
              console.error("Error:", error);
            });
        });

        joinGameBtn.addEventListener("click", () => {
          const name = document.getElementById("playerNameInput").value.trim();
          const gameId = document.getElementById("gameIdInput").value.trim();

          if (!name || !gameId) {
            showMessage("Nom et ID de partie requis", true);
            return;
          }

          joinGame(gameId, name);
        });

        joinAsCreatorBtn.addEventListener("click", () => {
          const name = document.getElementById("creatorNameInput").value.trim();

          if (!name) {
            showMessage("Nom requis", true);
            return;
          }

          joinGame(currentGame.gameId, name);
        });

        copyGameIdBtn.addEventListener("click", () => {
          navigator.clipboard
            .writeText(currentGame.gameId)
            .then(() => showMessage("ID copié!"))
            .catch(() => showMessage("Erreur de copie", true));
        });

        endTurnBtn.addEventListener("click", () => {
          if (!currentGame.isMyTurn) return;

          socket.emit("endTurn", {
            gameId: currentGame.gameId,
            playerId: currentGame.playerId,
          });

          currentGame.isMyTurn = false;
          endTurnBtn.classList.add("hidden");
          updateGameStatus();
        });

        // Game functions
        function joinGame(gameId, playerName) {
          showScreen("waiting");
          document.getElementById("waitingMessage").textContent =
            "Connexion en cours...";

          fetch(`/api/games/${gameId}/join`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: playerName }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                currentGame.gameId = data.gameId;
                currentGame.playerId = data.playerId;
                currentGame.playerName = playerName;

                // Connexion socket
                document.getElementById("waitingMessage").textContent =
                  "En attente d'un adversaire...";
                socket.emit("joinRoom", {
                  gameId: data.gameId,
                  playerId: data.playerId,
                });
              } else {
                showMessage("Erreur: " + data.error, true);
                showScreen("home");
              }
            })
            .catch((error) => {
              showMessage("Erreur de connexion", true);
              showScreen("home");
              console.error("Error:", error);
            });
        }

        function updateGameStatus() {
          gameStatus.textContent = currentGame.isMyTurn
            ? "C'est votre tour!"
            : "Au tour de l'adversaire";
        }

        // Socket.io Events
        socket.on("connect", () => {
          console.log("Connecté au serveur");
        });

        socket.on("error", (data) => {
          showMessage("Erreur: " + data.message, true);
        });

        socket.on("gameState", (data) => {
          const game = data.game;
          currentGame.isMyTurn = game.currentTurn === currentGame.playerId;

          if (game.status === "playing") {
            showScreen("game");
            updateGameStatus();

            if (currentGame.isMyTurn) {
              endTurnBtn.classList.remove("hidden");
            } else {
              endTurnBtn.classList.add("hidden");
            }
          }
        });

        socket.on("playerJoined", (data) => {
          showMessage(`${data.playerName} a rejoint la partie`);
        });

        socket.on("turnChanged", (data) => {
          currentGame.isMyTurn = data.currentTurn === currentGame.playerId;
          updateGameStatus();

          if (currentGame.isMyTurn) {
            endTurnBtn.classList.remove("hidden");
            showMessage("C'est votre tour!");
          } else {
            endTurnBtn.classList.add("hidden");
            showMessage("Au tour de l'adversaire");
          }
        });

        socket.on("playerLeft", (data) => {
          showMessage("L'adversaire s'est déconnecté");
        });

        // Check for existing game in localStorage
        const savedGameId = localStorage.getItem("gameId");
        const savedPlayerId = localStorage.getItem("playerId");
        const savedPlayerName = localStorage.getItem("playerName");

        if (savedGameId && savedPlayerId) {
          const rejoin = confirm(
            "Partie en cours trouvée. Voulez-vous la rejoindre?"
          );
          if (rejoin) {
            currentGame.gameId = savedGameId;
            currentGame.playerId = savedPlayerId;
            currentGame.playerName = savedPlayerName;

            showScreen("waiting");
            document.getElementById("waitingMessage").textContent =
              "Reconnexion en cours...";
            socket.emit("joinRoom", {
              gameId: savedGameId,
              playerId: savedPlayerId,
            });
          } else {
            localStorage.removeItem("gameId");
            localStorage.removeItem("playerId");
            localStorage.removeItem("playerName");
          }
        }
      });
    </script>
  </body>
</html>
