<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Victorryan</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        margin-top: 20px;
      }
      .hidden {
        display: none;
      }
      button {
        padding: 8px 16px;
        background-color: #4caf50;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 4px;
        margin: 5px;
      }
      button:hover {
        background-color: #45a049;
      }
      input {
        padding: 8px;
        margin-bottom: 10px;
        width: 100%;
        border-radius: 4px;
        border: 1px solid #ddd;
      }
      .game-id {
        background-color: #f1f1f1;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      /* Styles pour les cartes */
      .cards-container {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 10px;
        justify-content: flex-start;
      }

      .card {
        width: 180px;
        height: 280px;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        background-color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        margin-bottom: 15px;
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .card.selected {
        border: 2px solid #4caf50;
      }

      .card-image {
        width: 100%;
        height: 180px;
        background-size: contain;
        background-position: center;
        background-repeat: no-repeat;
        margin-bottom: 8px;
      }

      .card-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: rgba(255, 255, 255, 0.8);
        padding: 5px;
        border-top: 1px solid #ddd;
      }

      .card-title {
        font-weight: bold;
        text-align: center;
        margin-bottom: 5px;
        font-size: 14px;
      }

      .card-stats {
        font-size: 12px;
        line-height: 1.4;
      }

      .personnage-card {
        background-color: #e8f5e9;
      }

      .bonus-card {
        background-color: #e3f2fd;
      }

      .opponent-card {
        background-color: #fff3e0;
      }

      .player-section {
        background-color: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .game-status {
        background-color: #333;
        color: white;
        padding: 10px;
        text-align: center;
        border-radius: 4px;
        margin-bottom: 20px;
      }

      .actions {
        display: flex;
        justify-content: center;
        margin-top: 20px;
      }

      .active-bonus-indicator {
        position: absolute;
        top: 5px;
        right: 5px;
        background-color: #ff9800;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
      }

      .game-info {
        background-color: #f1f1f1;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 20px;
      }

      .turn-indicator {
        font-weight: bold;
        color: #4caf50;
      }
    </style>
  </head>
  <body>
    <h1>Victorryan - Jeu de cartes</h1>

    <!-- Écran initial -->
    <div id="homeScreen">
      <button id="createGameBtn">Créer une partie</button>
      <hr />
      <div>
        <h3>Rejoindre une partie</h3>
        <input type="text" id="playerNameInput" placeholder="Votre nom" />
        <input type="text" id="gameIdInput" placeholder="ID de la partie" />
        <button id="joinGameBtn">Rejoindre</button>
      </div>
    </div>

    <!-- Écran de création de partie -->
    <div id="createdGameScreen" class="hidden">
      <h2>Partie créée!</h2>
      <p>Partagez cet ID avec votre adversaire:</p>
      <div class="game-id">
        <span id="gameIdDisplay"></span>
        <button id="copyGameIdBtn">Copier</button>
      </div>
      <div>
        <input type="text" id="creatorNameInput" placeholder="Votre nom" />
        <button id="joinAsCreatorBtn">Rejoindre en tant que créateur</button>
      </div>
    </div>

    <!-- Écran d'attente -->
    <div id="waitingScreen" class="hidden">
      <h2>En attente...</h2>
      <p id="waitingMessage">En attente d'un adversaire</p>
    </div>

    <!-- Écran de jeu -->
    <div id="gameScreen" class="hidden">
      <div class="game-status" id="gameStatus">En attente...</div>

      <div class="game-info">
        <h3>Informations de la partie</h3>
        <div id="gameInfo">
          <p>
            Votre tour:
            <span id="turnIndicator" class="turn-indicator">En attente...</span>
          </p>
          <p>Joueur 1: <span id="player1Name"></span></p>
          <p>Joueur 2: <span id="player2Name"></span></p>
        </div>
      </div>

      <div class="player-section">
        <h3>Vos personnages</h3>
        <div class="cards-container" id="yourCharacters"></div>
      </div>

      <div class="player-section">
        <h3>Vos bonus</h3>
        <div class="cards-container" id="yourBonus"></div>
      </div>

      <div class="player-section">
        <h3>Personnages adverses</h3>
        <div class="cards-container" id="opponentCharacters"></div>
      </div>

      <div class="actions">
        <button id="attackBtn" class="hidden">Attaquer</button>
        <button id="playBonusBtn" class="hidden">Jouer bonus</button>
        <button id="endTurnBtn" class="hidden">Terminer le tour</button>
      </div>
    </div>

    <div id="messages"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // DOM Elements
        const screens = {
          home: document.getElementById("homeScreen"),
          created: document.getElementById("createdGameScreen"),
          waiting: document.getElementById("waitingScreen"),
          game: document.getElementById("gameScreen"),
        };

        const createGameBtn = document.getElementById("createGameBtn");
        const joinGameBtn = document.getElementById("joinGameBtn");
        const joinAsCreatorBtn = document.getElementById("joinAsCreatorBtn");
        const gameIdDisplay = document.getElementById("gameIdDisplay");
        const copyGameIdBtn = document.getElementById("copyGameIdBtn");
        const gameStatus = document.getElementById("gameStatus");
        const endTurnBtn = document.getElementById("endTurnBtn");
        const attackBtn = document.getElementById("attackBtn");
        const playBonusBtn = document.getElementById("playBonusBtn");
        const messages = document.getElementById("messages");

        // DOM Elements pour les cartes
        const yourCharacters = document.getElementById("yourCharacters");
        const yourBonus = document.getElementById("yourBonus");
        const opponentCharacters =
          document.getElementById("opponentCharacters");

        // Game State
        let gameState = {
          gameId: null,
          playerId: null,
          playerName: null,
          isMyTurn: false,
          gameData: null,
          selectedCharacter: null,
          selectedBonus: null,
          targetCharacter: null,
        };

        // Socket.io
        const socket = io();

        // Functions
        function showScreen(screenName) {
          Object.keys(screens).forEach((key) => {
            screens[key].classList.add("hidden");
          });
          screens[screenName].classList.remove("hidden");
        }

        function showMessage(text, isError = false) {
          const p = document.createElement("p");
          p.textContent = text;
          if (isError) p.style.color = "red";
          messages.appendChild(p);
          messages.scrollTop = messages.scrollHeight;
        }

        // Fonction pour afficher les cartes des joueurs
        function renderCards() {
          if (!gameState.gameData) return;

          const game = gameState.gameData;
          const player = game.players[gameState.playerId];

          if (!player || !player.cards) {
            console.log("Données du joueur non disponibles");
            return;
          }

          // Trouver l'adversaire
          let opponent = null;
          for (const id in game.players) {
            if (id !== gameState.playerId) {
              opponent = game.players[id];
              break;
            }
          }

          // Afficher vos cartes personnages
          yourCharacters.innerHTML = "";
          player.cards.personnages.forEach((card) => {
            const cardEl = createCharacterCard(
              card,
              player.charactersState[card.id],
              false
            );
            cardEl.addEventListener("click", () =>
              selectYourCharacter(card.id)
            );
            if (card.id === gameState.selectedCharacter) {
              cardEl.classList.add("selected");
            }
            yourCharacters.appendChild(cardEl);
          });

          // Afficher vos cartes bonus
          yourBonus.innerHTML = "";
          player.cards.bonus.forEach((card) => {
            const cardEl = createBonusCard(card);
            cardEl.addEventListener("click", () => selectBonus(card.id));
            if (card.id === gameState.selectedBonus) {
              cardEl.classList.add("selected");
            }
            yourBonus.appendChild(cardEl);
          });

          // Afficher les cartes personnages de l'adversaire
          opponentCharacters.innerHTML = "";
          if (opponent && opponent.cards) {
            opponent.cards.personnages.forEach((card) => {
              const cardEl = createCharacterCard(
                card,
                opponent.charactersState[card.id],
                true
              );
              if (gameState.isMyTurn && gameState.selectedCharacter) {
                cardEl.addEventListener("click", () =>
                  selectOpponentCharacter(card.id)
                );
              }
              if (card.id === gameState.targetCharacter) {
                cardEl.classList.add("selected");
              }
              opponentCharacters.appendChild(cardEl);
            });
          }

          // Mettre à jour les boutons d'action
          updateActionButtons();
        }

        function createCharacterCard(card, state, isOpponent) {
          const cardEl = document.createElement("div");
          cardEl.className = `card ${
            isOpponent ? "opponent-card" : "personnage-card"
          }`;
          cardEl.dataset.id = card.id;

          // Valeurs à afficher, en tenant compte des modifications d'état
          const health = state ? state.currentHealth : card.PV;
          const attack = state ? state.currentAttack : card.force_attaque;
          const turns = state ? state.currentTurns : card.tours_attaque;

          // Vérifier si des bonus sont actifs sur cette carte
          const activeBonus =
            state && state.activeBonus ? state.activeBonus : [];

          // Ajouter l'image de la carte
          let imageHtml = "";
          if (card.fond) {
            imageHtml = `<div class="card-image" style="background-image: url('${card.fond}')"></div>`;
          }

          // Indicateur de bonus actifs
          const bonusIndicator =
            activeBonus.length > 0
              ? `<div class="active-bonus-indicator">${activeBonus.length}</div>`
              : "";

          cardEl.innerHTML = `
            ${bonusIndicator}
            <div class="card-title">${card.nom || "Personnage"}</div>
            ${imageHtml}
            <div class="card-overlay">
              <div class="card-stats">
                <div><strong>PV:</strong> ${health}</div>
                <div><strong>Attaque:</strong> ${attack}</div>
                <div><strong>Tours:</strong> ${turns}</div>
              </div>
            </div>
          `;

          return cardEl;
        }

        function createBonusCard(card) {
          const cardEl = document.createElement("div");
          cardEl.className = "card bonus-card";
          cardEl.dataset.id = card.id;

          let imageHtml = "";
          if (card.fond) {
            imageHtml = `<div class="card-image" style="background-image: url('${card.fond}')"></div>`;
          }

          cardEl.innerHTML = `
            <div class="card-title">${card.nom || "Bonus"}</div>
            ${imageHtml}
            <div class="card-overlay">
              <div class="card-stats">
                <div><strong>Effet:</strong> ${card.effet || "-"}</div>
                <div><strong>Pourcentage:</strong> ${
                  card.pourcentage || "0"
                }%</div>
                <div><strong>Tours:</strong> ${card.tours || "1"}</div>
              </div>
            </div>
          `;

          return cardEl;
        }

        function selectYourCharacter(cardId) {
          if (!gameState.isMyTurn) return;

          if (gameState.selectedCharacter === cardId) {
            gameState.selectedCharacter = null;
          } else {
            gameState.selectedCharacter = cardId;
          }

          updateActionButtons();
          renderCards();
        }

        function selectOpponentCharacter(cardId) {
          if (!gameState.isMyTurn || !gameState.selectedCharacter) return;

          if (gameState.targetCharacter === cardId) {
            gameState.targetCharacter = null;
          } else {
            gameState.targetCharacter = cardId;

            // Si on a sélectionné un personnage à attaquer, on peut proposer d'attaquer
            if (gameState.selectedCharacter && gameState.targetCharacter) {
              attackBtn.classList.remove("hidden");
            }
          }

          renderCards();
        }

        function selectBonus(cardId) {
          if (!gameState.isMyTurn) return;

          // Vérifier si le bonus est déjà sélectionné
          if (gameState.selectedBonus === cardId) {
            gameState.selectedBonus = null;
          } else {
            gameState.selectedBonus = cardId;
          }

          updateActionButtons();
          renderCards();
        }

        function updateActionButtons() {
          if (gameState.isMyTurn) {
            endTurnBtn.classList.remove("hidden");

            // Le bouton d'attaque est visible seulement si un personnage est sélectionné et une cible
            attackBtn.classList.toggle(
              "hidden",
              !(gameState.selectedCharacter && gameState.targetCharacter)
            );

            // Le bouton pour jouer un bonus est visible seulement si un bonus et un personnage sont sélectionnés
            playBonusBtn.classList.toggle(
              "hidden",
              !(gameState.selectedBonus && gameState.selectedCharacter)
            );
          } else {
            endTurnBtn.classList.add("hidden");
            attackBtn.classList.add("hidden");
            playBonusBtn.classList.add("hidden");
          }
        }

        function updateGameStatus() {
          if (gameState.gameData && gameState.gameData.status === "playing") {
            gameStatus.textContent = gameState.isMyTurn
              ? "C'est votre tour!"
              : "Au tour de l'adversaire";

            document.getElementById("turnIndicator").textContent =
              gameState.isMyTurn ? "Oui" : "Non";

            // Mettre à jour les noms des joueurs
            const playerIds = Object.keys(gameState.gameData.players);
            if (playerIds.length > 0) {
              const player1 = gameState.gameData.players[playerIds[0]];
              document.getElementById("player1Name").textContent = player1.name;
            }

            if (playerIds.length > 1) {
              const player2 = gameState.gameData.players[playerIds[1]];
              document.getElementById("player2Name").textContent = player2.name;
            }
          } else {
            gameStatus.textContent = "En attente d'un adversaire...";
            document.getElementById("turnIndicator").textContent = "En attente";
          }
        }

        // Event handlers
        createGameBtn.addEventListener("click", () => {
          fetch("/api/games", {
            method: "POST",
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                gameState.gameId = data.gameId;
                gameIdDisplay.textContent = data.gameId;
                showScreen("created");
              } else {
                showMessage("Erreur: " + data.error, true);
              }
            })
            .catch((error) => {
              showMessage("Erreur de connexion", true);
              console.error("Error:", error);
            });
        });

        joinGameBtn.addEventListener("click", () => {
          const name = document.getElementById("playerNameInput").value.trim();
          const gameId = document.getElementById("gameIdInput").value.trim();

          if (!name || !gameId) {
            showMessage("Nom et ID de partie requis", true);
            return;
          }

          joinGame(gameId, name);
        });

        joinAsCreatorBtn.addEventListener("click", () => {
          const name = document.getElementById("creatorNameInput").value.trim();

          if (!name) {
            showMessage("Nom requis", true);
            return;
          }

          joinGame(gameState.gameId, name);
        });

        copyGameIdBtn.addEventListener("click", () => {
          navigator.clipboard
            .writeText(gameState.gameId)
            .then(() => showMessage("ID copié!"))
            .catch(() => showMessage("Erreur de copie", true));
        });

        endTurnBtn.addEventListener("click", () => {
          if (!gameState.isMyTurn) return;

          socket.emit("endTurn", {
            gameId: gameState.gameId,
            playerId: gameState.playerId,
          });

          // Réinitialiser les sélections
          gameState.selectedCharacter = null;
          gameState.selectedBonus = null;
          gameState.targetCharacter = null;
        });

        attackBtn.addEventListener("click", () => {
          if (
            !gameState.isMyTurn ||
            !gameState.selectedCharacter ||
            !gameState.targetCharacter
          )
            return;

          // Vérification que le personnage a des tours d'attaque
          const game = gameState.gameData;
          const player = game.players[gameState.playerId];
          const attacker = player.charactersState[gameState.selectedCharacter];

          if (attacker.currentTurns <= 0) {
            showMessage(
              "Ce personnage n'a plus de tours d'attaque disponibles.",
              true
            );
            return;
          }

          socket.emit("attackCharacter", {
            gameId: gameState.gameId,
            playerId: gameState.playerId,
            attackerId: gameState.selectedCharacter,
            targetId: gameState.targetCharacter,
          });

          showMessage(
            `Attaque avec ${gameState.selectedCharacter} sur ${gameState.targetCharacter}`
          );

          // Réinitialiser les sélections après l'attaque
          gameState.selectedCharacter = null;
          gameState.targetCharacter = null;
          renderCards();
        });

        playBonusBtn.addEventListener("click", () => {
          if (
            !gameState.isMyTurn ||
            !gameState.selectedBonus ||
            !gameState.selectedCharacter
          )
            return;

          socket.emit("playBonus", {
            gameId: gameState.gameId,
            playerId: gameState.playerId,
            bonusId: gameState.selectedBonus,
            targetCharacterId: gameState.selectedCharacter,
          });

          showMessage(
            `Bonus ${gameState.selectedBonus} joué sur ${gameState.selectedCharacter}`
          );

          // Réinitialiser seulement la sélection de bonus, pas le personnage
          // pour permettre d'appliquer plusieurs bonus sur le même personnage
          gameState.selectedBonus = null;
          renderCards();
        });

        // Game functions
        function joinGame(gameId, playerName) {
          showScreen("waiting");
          document.getElementById("waitingMessage").textContent =
            "Connexion en cours...";

          fetch(`/api/games/${gameId}/join`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: playerName }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                gameState.gameId = data.gameId;
                gameState.playerId = data.playerId;
                gameState.playerName = playerName;

                // Sauvegarder dans localStorage
                localStorage.setItem("gameId", data.gameId);
                localStorage.setItem("playerId", data.playerId);
                localStorage.setItem("playerName", playerName);

                // Connexion socket
                document.getElementById("waitingMessage").textContent =
                  "En attente d'un adversaire...";
                socket.emit("joinRoom", {
                  gameId: data.gameId,
                  playerId: data.playerId,
                });
              } else {
                showMessage("Erreur: " + data.error, true);
                showScreen("home");
              }
            })
            .catch((error) => {
              showMessage("Erreur de connexion", true);
              showScreen("home");
              console.error("Error:", error);
            });
        }

        // Socket.io Events
        socket.on("connect", () => {
          console.log("Connecté au serveur");
        });

        socket.on("error", (data) => {
          showMessage("Erreur: " + data.message, true);
        });

        socket.on("gameState", (data) => {
          console.log("État du jeu reçu:", data);

          gameState.gameData = data.game;
          gameState.isMyTurn =
            gameState.gameData.currentTurn === gameState.playerId;

          if (gameState.gameData.status === "playing") {
            showScreen("game");
            updateGameStatus();
            renderCards();
          }
        });

        socket.on("playerJoined", (data) => {
          showMessage(`${data.playerName} a rejoint la partie`);
        });

        socket.on("gameReady", (data) => {
          console.log("Partie prête:", data);
          gameState.gameData = data.game;
          gameState.isMyTurn = data.startingPlayer === gameState.playerId;

          showScreen("game");
          updateGameStatus();
          renderCards();

          showMessage("La partie commence!");
        });

        socket.on("turnChanged", (data) => {
          gameState.isMyTurn = data.currentTurn === gameState.playerId;
          updateGameStatus();
          updateActionButtons();

          if (gameState.isMyTurn) {
            showMessage("C'est votre tour!");
          } else {
            showMessage("Au tour de l'adversaire");
          }
        });

        socket.on("bonusPlayed", (data) => {
          // Mettre à jour l'état du jeu avec les nouvelles valeurs
          if (gameState.gameData && data.newGameState) {
            gameState.gameData = data.newGameState;
            renderCards();
          }

          showMessage(
            `${data.bonusName || "Un bonus"} a été joué sur ${
              data.targetName || "un personnage"
            }, augmentant son attaque de ${data.percentage || "x"}%`
          );
        });

        socket.on("characterAttacked", (data) => {
          // Mettre à jour l'état du jeu avec les nouvelles valeurs
          if (gameState.gameData && data.newGameState) {
            gameState.gameData = data.newGameState;
            renderCards();

            // Vérifier si la partie est terminée
            checkGameOver();
          }

          showMessage(
            `${data.attackerName || "Un personnage"} a attaqué ${
              data.targetName || "un autre personnage"
            } pour ${data.damage || "des"} dégâts!`
          );
        });

        socket.on("playerLeft", (data) => {
          showMessage("L'adversaire s'est déconnecté");
        });

        // Check for existing game in localStorage
        const savedGameId = localStorage.getItem("gameId");
        const savedPlayerId = localStorage.getItem("playerId");
        const savedPlayerName = localStorage.getItem("playerName");

        if (savedGameId && savedPlayerId) {
          const rejoin = confirm(
            "Partie en cours trouvée. Voulez-vous la rejoindre?"
          );
          if (rejoin) {
            gameState.gameId = savedGameId;
            gameState.playerId = savedPlayerId;
            gameState.playerName = savedPlayerName;

            showScreen("waiting");
            document.getElementById("waitingMessage").textContent =
              "Reconnexion en cours...";
            socket.emit("joinRoom", {
              gameId: savedGameId,
              playerId: savedPlayerId,
            });
          } else {
            localStorage.removeItem("gameId");
            localStorage.removeItem("playerId");
            localStorage.removeItem("playerName");
          }
        }

        // Ajouter une fonction pour vérifier si la partie est gagnée/perdue
        function checkGameOver() {
          if (!gameState.gameData) return false;

          const game = gameState.gameData;
          const player = game.players[gameState.playerId];

          // Trouver l'adversaire
          let opponent = null;
          for (const id in game.players) {
            if (id !== gameState.playerId) {
              opponent = game.players[id];
              break;
            }
          }

          if (!player || !opponent) return false;

          // Vérifier si tous les personnages d'un joueur sont à 0 PV
          const playerAlive = Object.values(player.charactersState).some(
            (char) => char.currentHealth > 0
          );
          const opponentAlive = Object.values(opponent.charactersState).some(
            (char) => char.currentHealth > 0
          );

          if (!playerAlive) {
            showMessage(
              "Vous avez perdu la partie ! Tous vos personnages sont vaincus.",
              true
            );
            return true;
          }

          if (!opponentAlive) {
            showMessage(
              "Vous avez gagné la partie ! Tous les personnages adverses sont vaincus."
            );
            return true;
          }

          return false;
        }
      });
    </script>
  </body>
</html>
