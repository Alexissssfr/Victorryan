<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Victor Ryan - Jeu de Cartes</title>
    <style>
      body {
        font-family: "Arial", sans-serif;
        background-color: #121212;
        color: #ffffff;
        margin: 0;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .game-info {
        text-align: center;
        margin-bottom: 20px;
        padding: 10px;
        background-color: #2d2d2d;
        border-radius: 5px;
      }

      .game-code {
        color: #e5b13a;
        font-size: 1.2em;
        font-weight: bold;
      }

      .turn-info {
        color: #4caf50;
        margin-top: 10px;
      }

      .player-stats {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
      }

      .player-info {
        flex: 1;
        padding: 15px;
        background-color: #2d2d2d;
        border-radius: 5px;
        margin: 0 10px;
      }

      .player-info h2 {
        color: #e5b13a;
        margin-top: 0;
      }

      .stats {
        display: flex;
        gap: 10px;
        align-items: center;
        margin: 5px 0;
      }

      .stats img {
        width: 20px;
        height: 20px;
      }

      .board {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
      }

      .player-board {
        flex: 1;
        padding: 20px;
        background-color: #2d2d2d;
        border-radius: 5px;
        margin: 0 10px;
        min-height: 300px;
      }

      .card {
        position: relative;
        height: 300px;
        border-radius: 10px;
        overflow: hidden;
        background-color: #1a1a1a;
        margin-bottom: 10px;
        cursor: pointer;
        transition: transform 0.3s;
      }

      .card:hover {
        transform: translateY(-5px);
      }

      .card img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .card-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.8);
        padding: 10px;
        transform: translateY(100%);
        transition: transform 0.3s;
      }

      .card:hover .card-overlay {
        transform: translateY(0);
      }

      .bonus-cards {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 20px;
      }

      .bonus-card {
        width: 150px;
        height: 200px;
      }

      .controls {
        text-align: center;
        margin-top: 20px;
      }

      button {
        padding: 10px 20px;
        font-size: 16px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      button:hover {
        background-color: #45a049;
      }

      button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="game-info">
        <div>Code partie: <span id="gameCode" class="game-code">-</span></div>
        <div class="turn-info">Tour: <span id="turnNumber">1</span></div>
      </div>

      <div class="player-stats">
        <div class="player-info">
          <h2>Adversaire</h2>
          <div class="stats">
            <span>‚ù§Ô∏è</span> <span id="opponentHP">525</span> <span>üé¥</span>
            <span id="opponentCards">5</span> <span>üåü</span>
            <span id="opponentBonus">0</span>
          </div>
        </div>
        <div class="player-info">
          <h2>Joueur</h2>
          <div class="stats">
            <span>‚ù§Ô∏è</span> <span id="playerHP">490</span> <span>üé¥</span>
            <span id="playerCards">5</span> <span>üåü</span>
            <span id="playerBonus">0</span>
          </div>
        </div>
      </div>

      <div class="board">
        <div id="opponentBoard" class="player-board">
          <h3>Cartes adversaire</h3>
          <div id="opponentCharacter"></div>
        </div>
        <div id="playerBoard" class="player-board">
          <h3>Vos cartes</h3>
          <div id="playerCharacter"></div>
          <div class="bonus-cards" id="playerBonusCards"></div>
        </div>
      </div>

      <div class="controls">
        <button id="endTurnBtn">Fin du tour</button>
      </div>
    </div>

    <script>
      let gameState = null;
      let playerId = "player1"; // √Ä adapter selon le joueur

      // Fonction pour cr√©er une carte
      function createCard(type, data, isOpponent = false) {
        const card = document.createElement("div");
        card.className = `card ${type === "bonus" ? "bonus-card" : ""}`;

        const img = document.createElement("img");
        fetch(`/api/image/${type}/${data.id}`)
          .then((response) => response.json())
          .then((imageData) => {
            img.src = imageData.url;
          })
          .catch(() => {
            img.src =
              "https://via.placeholder.com/200x300?text=Image+non+disponible";
          });

        const overlay = document.createElement("div");
        overlay.className = "card-overlay";

        if (type === "perso") {
          overlay.innerHTML = `
            <h3>${data.nomcarteperso}</h3>
            <p>PV: ${data.pointsdevie}</p>
            <p>Attaque: ${data.forceattaque}</p>
            <p>Tour: ${data.tourattaque}</p>
            <p>Pouvoir: ${data.nomdupouvoir}</p>
          `;
        } else {
          overlay.innerHTML = `
            <h3>${data.nom}</h3>
            <p>Effet: ${data.bonuspourcentage || data.effet}</p>
            <p>Tours: ${data.toursbonus}</p>
          `;

          if (!isOpponent) {
            card.onclick = () => useBonus(data);
          }
        }

        card.appendChild(img);
        card.appendChild(overlay);
        return card;
      }

      // Fonction pour mettre √† jour l'interface
      function updateUI(state) {
        document.getElementById("gameCode").textContent = state.gameId;
        document.getElementById("turnNumber").textContent = state.turn;

        // Mise √† jour des stats
        document.getElementById("playerHP").textContent = state.you.pv;
        document.getElementById("playerCards").textContent = state.you.cartes;
        document.getElementById("playerBonus").textContent = state.you.bonus;

        document.getElementById("opponentHP").textContent = state.opponent.pv;
        document.getElementById("opponentCards").textContent =
          state.opponent.cartes;
        document.getElementById("opponentBonus").textContent =
          state.opponent.bonus;

        // Mise √† jour des cartes
        const playerCharacter = document.getElementById("playerCharacter");
        const opponentCharacter = document.getElementById("opponentCharacter");
        const playerBonusCards = document.getElementById("playerBonusCards");

        playerCharacter.innerHTML = "";
        opponentCharacter.innerHTML = "";
        playerBonusCards.innerHTML = "";

        if (state.you.personnage) {
          playerCharacter.appendChild(
            createCard("perso", state.you.personnage)
          );
        }

        if (state.opponent.personnage) {
          opponentCharacter.appendChild(
            createCard("perso", state.opponent.personnage, true)
          );
        }

        state.you.cartesBonus.forEach((bonus) => {
          playerBonusCards.appendChild(createCard("bonus", bonus));
        });

        // Gestion du bouton de fin de tour
        document.getElementById("endTurnBtn").disabled =
          state.currentPlayer !== playerId;
      }

      // Fonction pour utiliser une carte bonus
      async function useBonus(bonusCard) {
        if (!gameState || gameState.currentPlayer !== playerId) return;

        try {
          const response = await fetch(`/api/game/${gameState.gameId}/bonus`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              playerId,
              bonusCard,
            }),
          });

          if (response.ok) {
            await updateGameState();
          }
        } catch (error) {
          console.error("Erreur lors de l'utilisation du bonus:", error);
        }
      }

      // Fonction pour terminer le tour
      async function endTurn() {
        if (!gameState || gameState.currentPlayer !== playerId) return;

        try {
          const response = await fetch(
            `/api/game/${gameState.gameId}/end-turn`,
            {
              method: "POST",
            }
          );

          if (response.ok) {
            await updateGameState();
          }
        } catch (error) {
          console.error("Erreur lors de la fin du tour:", error);
        }
      }

      // Fonction pour mettre √† jour l'√©tat du jeu
      async function updateGameState() {
        try {
          const urlParams = new URLSearchParams(window.location.search);
          const gameId = urlParams.get("gameId");

          if (!gameId) return;

          const response = await fetch(`/api/game/${gameId}/state/${playerId}`);
          if (response.ok) {
            gameState = await response.json();
            updateUI(gameState);
          }
        } catch (error) {
          console.error("Erreur lors de la mise √† jour de l'√©tat:", error);
        }
      }

      // Initialisation
      document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("endTurnBtn").onclick = endTurn;

        // Mise √† jour p√©riodique de l'√©tat
        updateGameState();
        setInterval(updateGameState, 2000);
      });
    </script>
  </body>
</html>
