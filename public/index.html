<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Victorryan - Jeu de Cartes</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f0f0f0;
        margin: 0;
        padding: 0;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }

      h1,
      h2,
      h3 {
        color: #333;
      }

      .hidden {
        display: none;
      }

      .setup-options {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-top: 30px;
      }

      .create-game,
      .join-game {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .btn {
        background-color: #4caf50;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
      }

      .btn:hover {
        background-color: #45a049;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
      }

      .form-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
      }

      .game-id-container {
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .btn-small {
        font-size: 14px;
        padding: 5px 10px;
        background-color: #007bff;
      }

      .game-board {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
      }

      .player-area {
        background-color: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .character-card,
      .bonus-card {
        border: 1px solid #ddd;
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
        background-color: #f9f9f9;
        cursor: pointer;
      }

      .character-card.active {
        border: 2px solid #4caf50;
      }

      .messages {
        margin-top: 20px;
        padding: 10px;
        border-radius: 4px;
        background-color: #fff8e1;
        border-left: 4px solid #ffc107;
      }

      .status-bar {
        background-color: #333;
        color: white;
        padding: 10px;
        text-align: center;
        position: sticky;
        top: 0;
        z-index: 100;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Victorryan - Jeu de Cartes</h1>

      <!-- Écran de configuration -->
      <div id="setupScreen">
        <div class="setup-options">
          <div class="create-game">
            <h2>Créer une nouvelle partie</h2>
            <button id="createGameBtn" class="btn">Créer une partie</button>
            <div id="gameIdDisplay" class="hidden">
              <p>Partagez cet ID avec votre adversaire :</p>
              <div class="game-id-container">
                <span id="gameIdText"></span>
                <button id="copyGameIdBtn" class="btn-small">Copier</button>
              </div>
              <div class="form-group">
                <label for="creatorName">Votre nom :</label>
                <input
                  type="text"
                  id="creatorName"
                  placeholder="Entrez votre nom"
                />
              </div>
              <button id="joinAsCreatorBtn" class="btn">
                Rejoindre comme créateur
              </button>
            </div>
          </div>

          <div class="join-game">
            <h2>Rejoindre une partie existante</h2>
            <div class="form-group">
              <label for="playerName">Votre nom :</label>
              <input
                type="text"
                id="playerName"
                placeholder="Entrez votre nom"
              />
            </div>
            <div class="form-group">
              <label for="gameIdInput">ID de la partie :</label>
              <input
                type="text"
                id="gameIdInput"
                placeholder="Entrez l'ID de la partie"
              />
            </div>
            <button id="joinGameBtn" class="btn">Rejoindre la partie</button>
          </div>
        </div>
      </div>

      <!-- Écran de chargement/attente -->
      <div id="loadingScreen" class="hidden">
        <h2>En attente...</h2>
        <p id="loadingMessage">Connexion à la partie en cours...</p>
      </div>

      <!-- Écran de jeu -->
      <div id="gameScreen" class="hidden">
        <div class="status-bar">
          <span id="gameStatus">En attente du début de la partie</span>
        </div>

        <div class="game-board">
          <div class="player-area" id="yourArea">
            <h2>Vos cartes</h2>
            <h3>Personnages</h3>
            <div id="yourCharacters"></div>
            <h3>Bonus</h3>
            <div id="yourBonus"></div>
          </div>

          <div class="player-area" id="opponentArea">
            <h2>Adversaire</h2>
            <h3>Personnages</h3>
            <div id="opponentCharacters"></div>
          </div>
        </div>

        <div class="action-area">
          <div id="actionButtons" class="hidden">
            <button id="endTurnBtn" class="btn">Terminer le tour</button>
          </div>
          <div class="messages" id="gameMessages">
            Bienvenue dans la partie.
          </div>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Éléments DOM
        const setupScreen = document.getElementById("setupScreen");
        const loadingScreen = document.getElementById("loadingScreen");
        const gameScreen = document.getElementById("gameScreen");
        const loadingMessage = document.getElementById("loadingMessage");
        const gameStatus = document.getElementById("gameStatus");
        const gameMessages = document.getElementById("gameMessages");

        // Éléments de création de partie
        const createGameBtn = document.getElementById("createGameBtn");
        const gameIdDisplay = document.getElementById("gameIdDisplay");
        const gameIdText = document.getElementById("gameIdText");
        const copyGameIdBtn = document.getElementById("copyGameIdBtn");
        const creatorName = document.getElementById("creatorName");
        const joinAsCreatorBtn = document.getElementById("joinAsCreatorBtn");

        // Éléments pour rejoindre une partie
        const playerName = document.getElementById("playerName");
        const gameIdInput = document.getElementById("gameIdInput");
        const joinGameBtn = document.getElementById("joinGameBtn");

        // Éléments du jeu
        const yourCharacters = document.getElementById("yourCharacters");
        const yourBonus = document.getElementById("yourBonus");
        const opponentCharacters =
          document.getElementById("opponentCharacters");
        const actionButtons = document.getElementById("actionButtons");
        const endTurnBtn = document.getElementById("endTurnBtn");

        // Variables du jeu
        let socket;
        let currentGameId;
        let currentPlayerId;
        let gameData;
        let myTurn = false;
        let selectedCharacter = null;
        let selectedBonus = null;

        // Initialiser l'application
        init();

        function init() {
          socket = io();
          addEventListeners();
          setupSocketListeners();
          checkExistingGame();
        }

        // Configuration des écouteurs de socket
        function setupSocketListeners() {
          socket.on("connect", () => {
            console.log("Connecté au serveur WebSocket");
          });

          socket.on("error", (data) => {
            showMessage(`Erreur: ${data.message}`, "error");
            showSetupScreen();
          });

          socket.on("gameJoined", (data) => {
            console.log("Partie rejointe:", data);
            gameData = data.game;

            if (gameData.gameState === "waiting") {
              loadingMessage.textContent = "En attente d'un adversaire...";
            } else if (gameData.gameState === "playing") {
              showGameScreen();
              updateGameUI();
            }
          });

          socket.on("playerConnected", (data) => {
            showMessage(`${data.playerName} a rejoint la partie.`);
          });

          socket.on("gameReady", (data) => {
            console.log("Partie prête à démarrer:", data);
            gameData = data.game;
            myTurn = data.startingPlayer === currentPlayerId;
            showMessage("La partie commence!");
            showGameScreen();
            updateGameUI();
          });

          socket.on("turnChanged", (data) => {
            myTurn = data.currentTurn === currentPlayerId;
            updateGameStatus();
            showMessage(
              myTurn ? "C'est votre tour!" : "Au tour de l'adversaire."
            );
          });

          socket.on("playerDisconnected", (data) => {
            showMessage("Votre adversaire s'est déconnecté.");
          });
        }

        // Ajouter les écouteurs d'événements
        function addEventListeners() {
          createGameBtn.addEventListener("click", createGame);
          copyGameIdBtn.addEventListener("click", copyGameId);
          joinAsCreatorBtn.addEventListener("click", joinAsCreator);
          joinGameBtn.addEventListener("click", joinGame);
          endTurnBtn.addEventListener("click", endTurn);
        }

        // Créer une nouvelle partie
        function createGame() {
          fetch("/api/games", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                currentGameId = data.gameId;
                gameIdText.textContent = currentGameId;
                gameIdDisplay.classList.remove("hidden");
              } else {
                showMessage(`Erreur: ${data.error}`, "error");
              }
            })
            .catch((error) => {
              console.error("Erreur:", error);
              showMessage("Erreur lors de la création de la partie.", "error");
            });
        }

        // Rejoindre en tant que créateur
        function joinAsCreator() {
          const name = creatorName.value.trim();
          if (!name) {
            showMessage("Veuillez entrer votre nom.", "error");
            return;
          }

          joinGameWithDetails(currentGameId, name);
        }

        // Rejoindre une partie existante
        function joinGame() {
          const name = playerName.value.trim();
          const gameId = gameIdInput.value.trim();

          if (!name || !gameId) {
            showMessage("Veuillez remplir tous les champs.", "error");
            return;
          }

          joinGameWithDetails(gameId, name);
        }

        // Fonction commune pour rejoindre une partie
        function joinGameWithDetails(gameId, playerName) {
          showLoadingScreen("Connexion à la partie...");

          fetch(`/api/games/${gameId}/join`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ playerName }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                currentGameId = data.gameId;
                currentPlayerId = data.playerId;

                // Sauvegarder les détails dans localStorage
                localStorage.setItem("gameId", currentGameId);
                localStorage.setItem("playerId", currentPlayerId);
                localStorage.setItem("playerName", playerName);

                // Rejoindre la salle WebSocket
                socket.emit("joinGameRoom", {
                  gameId: currentGameId,
                  playerId: currentPlayerId,
                });
              } else {
                showMessage(`Erreur: ${data.error}`, "error");
                showSetupScreen();
              }
            })
            .catch((error) => {
              console.error("Erreur:", error);
              showMessage("Erreur lors de la connexion à la partie.", "error");
              showSetupScreen();
            });
        }

        // Vérifier s'il y a une partie en cours
        function checkExistingGame() {
          const gameId = localStorage.getItem("gameId");
          const playerId = localStorage.getItem("playerId");
          const playerName = localStorage.getItem("playerName");

          if (gameId && playerId) {
            const rejoin = confirm(
              "Vous avez une partie en cours. Voulez-vous la rejoindre?"
            );
            if (rejoin) {
              currentGameId = gameId;
              currentPlayerId = playerId;
              showLoadingScreen("Reconnexion à la partie...");
              socket.emit("joinGameRoom", { gameId, playerId });
            } else {
              // Effacer les données de la partie précédente
              localStorage.removeItem("gameId");
              localStorage.removeItem("playerId");
              localStorage.removeItem("playerName");
            }
          }
        }

        // Fin de tour
        function endTurn() {
          if (!myTurn) return;

          socket.emit("endTurn");
          selectedCharacter = null;
          selectedBonus = null;
          updateGameUI();
        }

        // Copier l'ID de partie dans le presse-papiers
        function copyGameId() {
          navigator.clipboard
            .writeText(gameIdText.textContent)
            .then(() => {
              showMessage("ID de partie copié dans le presse-papiers!");
            })
            .catch((err) => {
              console.error("Erreur lors de la copie:", err);
            });
        }

        // Sélectionner un personnage
        function selectCharacter(cardId) {
          selectedCharacter = selectedCharacter === cardId ? null : cardId;
          updateCharacterSelection();
        }

        // Sélectionner un bonus
        function selectBonus(cardId) {
          selectedBonus = selectedBonus === cardId ? null : cardId;
          if (selectedBonus && selectedCharacter) {
            playBonus(selectedBonus, selectedCharacter);
          }
        }

        // Attaquer un personnage adverse
        function attackCharacter(targetId) {
          if (!myTurn || !selectedCharacter) return;

          socket.emit("attackCharacter", {
            attackerId: selectedCharacter,
            targetId: targetId,
          });

          // Désélectionner après l'attaque
          selectedCharacter = null;
          updateCharacterSelection();
        }

        // Jouer un bonus sur un personnage
        function playBonus(bonusId, characterId) {
          if (!myTurn) return;

          socket.emit("playBonus", {
            cardId: bonusId,
            targetCharacterId: characterId,
          });

          // Désélectionner après avoir joué
          selectedBonus = null;
          selectedCharacter = null;
          updateCharacterSelection();
        }

        // Mise à jour de l'interface utilisateur
        function updateGameUI() {
          if (!gameData) return;

          updateGameStatus();

          // Si c'est notre tour, activer les boutons d'action
          actionButtons.classList.toggle("hidden", !myTurn);

          // Trouver qui est l'adversaire
          const opponentId = Object.keys(gameData.players).find(
            (id) => id !== currentPlayerId
          );

          // Mettre à jour les cartes personnages et bonus
          if (gameData.players[currentPlayerId]) {
            renderCharacters(yourCharacters, gameData.players[currentPlayerId]);
            renderBonusCards(yourBonus, gameData.players[currentPlayerId]);
          }

          if (opponentId && gameData.players[opponentId]) {
            renderCharacters(
              opponentCharacters,
              gameData.players[opponentId],
              true
            );
          }
        }

        // Mettre à jour l'état du jeu affiché
        function updateGameStatus() {
          if (gameData.gameState === "waiting") {
            gameStatus.textContent = "En attente d'un adversaire";
          } else if (gameData.gameState === "playing") {
            gameStatus.textContent = myTurn
              ? "C'est votre tour!"
              : "Au tour de l'adversaire";
          } else if (gameData.gameState === "finished") {
            gameStatus.textContent = "Partie terminée";
          }
        }

        // Mettre à jour la sélection de personnage
        function updateCharacterSelection() {
          const cards = document.querySelectorAll(".character-card");
          cards.forEach((card) => {
            card.classList.toggle(
              "active",
              card.dataset.cardId === selectedCharacter
            );
          });
        }

        // Afficher un message
        function showMessage(message, type = "info") {
          const messageElement = document.createElement("p");
          messageElement.textContent = message;

          if (type === "error") {
            messageElement.style.color = "red";
          }

          gameMessages.appendChild(messageElement);
          gameMessages.scrollTop = gameMessages.scrollHeight;
        }

        // Fonction pour afficher l'écran de chargement
        function showLoadingScreen(message) {
          setupScreen.classList.add("hidden");
          gameScreen.classList.add("hidden");
          loadingScreen.classList.remove("hidden");

          if (message) {
            loadingMessage.textContent = message;
          }
        }

        // Fonction pour afficher l'écran de configuration
        function showSetupScreen() {
          setupScreen.classList.remove("hidden");
          gameScreen.classList.add("hidden");
          loadingScreen.classList.add("hidden");
        }

        // Fonction pour afficher l'écran de jeu
        function showGameScreen() {
          setupScreen.classList.add("hidden");
          loadingScreen.classList.add("hidden");
          gameScreen.classList.remove("hidden");
        }

        // Rendu des cartes personnage
        function renderCharacters(container, playerData, isOpponent = false) {
          container.innerHTML = "";

          if (!playerData || !playerData.hand || !playerData.hand.personnages) {
            return;
          }

          playerData.hand.personnages.forEach((card) => {
            const characterState = playerData.charactersState[card.id];
            if (!characterState) return;

            const cardElement = document.createElement("div");
            cardElement.className = "character-card";
            cardElement.dataset.cardId = card.id;

            if (card.id === selectedCharacter) {
              cardElement.classList.add("active");
            }

            cardElement.innerHTML = `
                    <h4>${card.nom || "Personnage"}</h4>
                    <p>PV: ${characterState.currentHealth}</p>
                    <p>Attaque: ${characterState.currentAttack}</p>
                    <p>Tours: ${characterState.currentTurns}</p>
                `;

            if (!isOpponent && myTurn) {
              cardElement.addEventListener("click", () =>
                selectCharacter(card.id)
              );
            } else if (isOpponent && myTurn && selectedCharacter) {
              cardElement.addEventListener("click", () =>
                attackCharacter(card.id)
              );
            }

            container.appendChild(cardElement);
          });
        }

        // Rendu des cartes bonus
        function renderBonusCards(container, playerData) {
          container.innerHTML = "";

          if (!playerData || !playerData.hand || !playerData.hand.bonus) {
            return;
          }

          playerData.hand.bonus.forEach((card) => {
            const cardElement = document.createElement("div");
            cardElement.className = "bonus-card";
            cardElement.dataset.cardId = card.id;

            if (card.id === selectedBonus) {
              cardElement.classList.add("active");
            }

            cardElement.innerHTML = `
                    <h4>${card.nom || "Bonus"}</h4>
                    <p>Effet: ${card.effet || "Inconnu"}</p>
                    <p>Tours: ${card.tours || 1}</p>
                    <p>Bonus: ${card.pourcentage || 0}%</p>
                `;

            if (myTurn) {
              cardElement.addEventListener("click", () => selectBonus(card.id));
            }

            container.appendChild(cardElement);
          });
        }
      });
    </script>
  </body>
</html>
